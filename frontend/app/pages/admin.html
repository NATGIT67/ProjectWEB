<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyRice Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .card { background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-top: 20px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .btn-save { background: var(--primary-color); color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; width: 100%; margin-top: 15px; font-size: 1rem; }
        .btn-save:hover { background: #45a049; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f5f5f5; font-weight: 600; }
        .btn-del { background: #ff5252; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .tab-btn { padding: 10px 20px; background: none; border: none; cursor: pointer; font-size: 1rem; color: #999; transition: 0.3s; }
        .tab-btn.active { color: var(--primary-color); border-bottom: 3px solid var(--primary-color); font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .status-pending { background: #fff3cd; color: #856404; padding: 5px 10px; border-radius: 4px; font-size: 0.85rem; }
        .status-approved { background: #d4edda; color: #155724; padding: 5px 10px; border-radius: 4px; font-size: 0.85rem; }
    </style>
</head>
<body>
    <header class="navbar">
        <div class="container">
            <a href="../" class="logo">üåæ EasyRice</a>
            <button class="hamburger" id="hamburger" onclick="toggleMenu()">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <nav id="navMenu">
                <ul>
                    <li><a href="../">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a></li>
                    <li><a href="product.html">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</a></li>
                    <li><a href="about.html">‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£</a></li>
                    <li><a href="contact.html">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</a></li>
                </ul>
            </nav>
            <div style="display: flex; gap: 10px; align-items: center;">
                <span id="adminName" style="color: var(--primary-color); font-weight: 500;"></span>
                <button id="logoutBtn" onclick="logout()" style="background: #ff5252; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>
    </header>

    <div class="container">
        <div style="display: flex; gap: 10px; margin-top: 20px; margin-bottom: 20px; border-bottom: 2px solid #ddd;">
            <button onclick="switchTab('products')" class="tab-btn active"><i class="fas fa-boxes"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
            <button onclick="switchTab('orders')" class="tab-btn"><i class="fas fa-clipboard-list"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
            <button onclick="switchTab('stock')" class="tab-btn"><i class="fas fa-warehouse"></i> ‡∏î‡∏π‡∏™‡∏ï‡πä‡∏≠‡∏Å</button>
        </div>

        <!-- TAB 1 -->
        <div id="products" class="tab-content active">
            <div class="card">
                <h3><i class="fas fa-plus-circle"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                <form id="addForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>‡∏ä‡∏∑‡πà‡∏≠</label>
                            <input type="text" id="pName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                            <input type="text" id="pDesc" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>‡∏≠‡∏≤‡∏¢‡∏∏‡∏Å‡∏•‡πâ‡∏≤ (‡∏ß‡∏±‡∏ô)</label>
                            <input type="number" id="pAge" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞</label>
                            <input type="text" id="pFeature" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>‡∏£‡∏≤‡∏Ñ‡∏≤</label>
                            <input type="number" id="pPrice" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>‡∏™‡∏ï‡πá‡∏≠‡∏Å</label>
                            <input type="number" id="pStock" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</label>
                        <input type="file" id="pImg" class="form-control" accept="image/*" required>
                    </div>
                    <button type="submit" class="btn-save">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </form>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-list"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                <table>
                    <thead>
                        <tr><th>‡∏£‡∏π‡∏õ</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏™‡∏ï‡πá‡∏≠‡∏Å</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr>
                    </thead>
                    <tbody id="productList"></tbody>
                </table>
            </div>
        </div>

        <!-- TAB 2 -->
        <div id="orders" class="tab-content">
            <div class="card">
                <h3><i class="fas fa-clipboard-list"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h3>
                <table>
                    <thead>
                        <tr><th>#</th><th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏°‡∏±‡∏î‡∏à‡∏≥</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏î‡∏π</th></tr>
                    </thead>
                    <tbody id="orderList"></tbody>
                </table>
            </div>
        </div>

        <!-- TAB 3 -->
        <div id="stock" class="tab-content">
            <div class="card">
                <h3><i class="fas fa-warehouse"></i> ‡∏™‡∏ï‡πä‡∏≠‡∏Å</h3>
                <table>
                    <thead>
                        <tr><th>‡∏£‡∏π‡∏õ</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤</th></tr>
                    </thead>
                    <tbody id="stockList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="orderModal" class="modal-overlay" style="display: none;">
        <div class="login-card modal-content" style="max-width: 600px;">
            <div class="login-header"><h2>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h2></div>
            <div id="orderDetail" style="max-height: 60vh; overflow-y: auto; padding: 20px; text-align: left;"></div>
            <button onclick="acceptOrder()" id="acceptBtn" class="btn-save" style="background: #2196F3;">‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
            <button onclick="closeOrderModal()" class="btn-save" style="background: #999; margin-top: 10px;">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <script src="../js/api-client.js"></script>
    <script>
        let currentOrderIdx = null;
        
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Check if user is admin
                const user = await api.getCurrentUser();
                if (!user.role || user.role !== 'admin') {
                    alert('‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
                    location.href = '../';
                    return;
                }
                document.getElementById('adminName').textContent = '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ' + (user.full_name || user.username);
            } catch (error) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
                location.href = 'sign-in.html';
                return;
            }
            
            document.getElementById('addForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const img = document.getElementById('pImg');
                if (!img.files.length) { alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ'); return; }
                const reader = new FileReader();
                reader.onload = async (ev) => {
                    try {
                        const product = await api.createProduct(
                            document.getElementById('pName').value,
                            document.getElementById('pDesc').value,
                            'Rice Seedling',
                            parseInt(document.getElementById('pPrice').value),
                            parseInt(document.getElementById('pStock').value),
                            ev.target.result
                        );
                        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
                        document.getElementById('addForm').reset();
                        loadProducts();
                        loadStock();
                    } catch (err) {
                        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
                    }
                };
                reader.readAsDataURL(img.files[0]);
            });
            loadProducts();
            loadOrders();
            loadStock();
        });

        async function loadProducts() {
            try {
                const response = await api.getProducts();
                let products = response.data || response || [];
                
                if (!products.length) {
                    products = [
                        {id: 1, product_name: '‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏≠‡∏°‡∏°‡∏∞‡∏•‡∏¥ 105', description: '‡∏Å‡∏•‡∏¥‡πà‡∏ô‡∏´‡∏≠‡∏°', price: 35, stock: 150, image_url: 'https://via.placeholder.com/100'},
                        {id: 2, product_name: '‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏£‡∏ã‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ‡πà', description: '‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û', price: 45, stock: 25, image_url: 'https://via.placeholder.com/100'}
                    ];
                }
                
                const tbody = document.getElementById('productList');
                tbody.innerHTML = '';
                products.forEach(p => {
                    const name = p.product_name || p.name;
                    const img = p.image_url || p.img || 'https://via.placeholder.com/40';
                    tbody.innerHTML += `<tr><td><img src="${img}" width="40" style="border-radius:4px;"></td><td>${name}</td><td>${p.price}</td><td>${p.stock}</td><td><button onclick="deleteProduct(${p.id})" class="btn-del"><i class="fas fa-trash"></i></button></td></tr>`;
                });
            } catch (error) {
                console.error('Load products error:', error);
            }
        }

        async function deleteProduct(id) {
            if (!confirm('‡∏•‡∏ö?')) return;
            try {
                await api.deleteProduct(id);
                loadProducts();
                loadStock();
            } catch (err) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
            }
        }

        async function loadOrders() {
            try {
                const response = await api.getAdminOrders();
                let orders = response.data || response || [];
                
                const tbody = document.getElementById('orderList');
                tbody.innerHTML = '';
                if (!orders.length) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ</td></tr>';
                    return;
                }
                orders.forEach((o, i) => {
                    const status = o.status || 'pending';
                    const st = status === 'pending' ? '<span class="status-pending">‡∏£‡∏≠</span>' : '<span class="status-approved">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>';
                    tbody.innerHTML += `<tr><td>${i+1}</td><td>${o.user_name || o.name || '-'}</td><td>${o.user_phone || o.phone || '-'}</td><td>${o.product_name || '-'}</td><td>${o.total_amount || 0}</td><td>${status}</td><td><button onclick="showOrder(${o.id})" style="padding:5px 10px; background:#2196F3; color:#fff; border:0; border-radius:4px; cursor:pointer;"><i class="fas fa-eye"></i></button></td></tr>`;
                });
            } catch (error) {
                console.error('Load orders error:', error);
            }
        }

        async function showOrder(orderId) {
            try {
                const response = await api.getOrder(orderId);
                const o = response.data || response;
                currentOrderIdx = orderId;
                
                document.getElementById('orderDetail').innerHTML = `
                    <p><strong>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå:</strong> ${o.id}</p>
                    <p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${o.user_name || '-'}</p>
                    <p><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå:</strong> ${o.user_phone || '-'}</p>
                    <p><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong> ${o.shipping_address || '-'}</p>
                    <p><strong>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</strong> ${o.product_name || '-'}</p>
                    <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</strong> ${o.quantity || '-'}</p>
                    <hr>
                    <p style="font-weight:bold;">‡∏£‡∏ß‡∏°: ${o.total_amount || 0} ‡∏ö‡∏≤‡∏ó</p>
                    <p style="font-weight:bold; color: #c62828;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${o.status || 'pending'}</p>
                `;
                document.getElementById('acceptBtn').style.display = o.status === 'pending' ? 'block' : 'none';
                document.getElementById('orderModal').style.display = 'flex';
            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        }

        async function acceptOrder() {
            try {
                await api.updateOrderStatus(currentOrderIdx, 'completed');
                alert('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß');
                closeOrderModal();
                loadOrders();
            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        }

        function closeOrderModal() {
            document.getElementById('orderModal').style.display = 'none';
        }

        async function loadStock() {
            try {
                const response = await api.getProducts();
                let products = response.data || response || [];
                
                const tbody = document.getElementById('stockList');
                tbody.innerHTML = '';
                let total = 0;
                products.forEach(p => {
                    const name = p.product_name || p.name;
                    const img = p.image_url || p.img || 'https://via.placeholder.com/40';
                    const val = p.price * p.stock;
                    total += val;
                    tbody.innerHTML += `<tr><td><img src="${img}" width="40" style="border-radius:4px;"></td><td>${name}</td><td>${p.stock}</td><td>${p.price}</td><td>${val.toLocaleString()}</td></tr>`;
                });
                tbody.innerHTML += `<tr style="background:#f5f5f5; font-weight:bold;"><td colspan="4" style="text-align:right;">‡∏£‡∏ß‡∏°:</td><td>${total.toLocaleString()}</td></tr>`;
            } catch (error) {
                console.error('Load stock error:', error);
            }
        }

        function logout() {
            api.clearToken();
            location.href = '../';
        }

        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active'));
            document.getElementById(t).classList.add('active');
            event.target.classList.add('active');

        // Mobile menu toggle
        function toggleMenu() {
            const hamburger = document.getElementById('hamburger');
            const navMenu = document.getElementById('navMenu');
            hamburger.classList.toggle('active');
            navMenu.classList.toggle('active');
        }

        // Close menu when link clicked
        document.querySelectorAll('#navMenu a').forEach(link => {
            link.addEventListener('click', () => {
                document.getElementById('hamburger').classList.remove('active');
                document.getElementById('navMenu').classList.remove('active');
            });
        });
    </script>
</body>
</html>