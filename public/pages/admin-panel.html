<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - EasyRice</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --sidebar-width: 250px;
            /* Reduced width */
            /* Modern Green Palette */
            --primary-gradient: linear-gradient(135deg, #2E7D32, #66BB6A);
            --primary-color: #2E7D32;
            --secondary-color: #81C784;
            --accent-color: #FFC107;
            --text-dark: #1B5E20;
            --text-light: #F1F8E9;
            --bg-glass: rgba(255, 255, 255, 0.95);
            /* Increased opacity for better contrast */
            --shadow-soft: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --border-glass: 1px solid rgba(255, 255, 255, 0.18);
        }

        /* ... body ... */

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            /* Reduced padding */
            overflow-y: auto;
            max-width: 100%;
            /* Prevent overflow */
            box-sizing: border-box;
        }

        /* Dashboard Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            /* Smaller min-width */
            gap: 20px;
            margin-bottom: 40px;
        }

        body {
            font-family: 'Kanit', sans-serif;
            margin: 0;
            padding: 0;
            background-image: url('../images/background.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            height: 100vh;
            overflow: hidden;
            color: #333;
        }

        /* Container */
        .admin-container {
            display: flex;
            height: 100vh;
            background: rgba(232, 245, 233, 0.6);
            /* Soft green overlay */
            backdrop-filter: blur(8px);
        }

        /* Sidebar Stylings */
        .sidebar {
            width: var(--sidebar-width);
            background-color: #1B5E20;
            /* Fallback solid color */
            background: linear-gradient(180deg, #1B5E20 0%, #2E7D32 100%);
            display: flex;
            flex-direction: column;
            color: white;
            padding: 30px 20px;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
            z-index: 100;
            /* Ensure it's above other elements */
            height: 100vh;
            /* Full height */
            overflow-y: auto;
            /* Allow scrolling if content is too long */
            position: fixed;
            /* Fix position so it doesn't scroll with main content */
            left: 0;
            top: 0;
        }

        .main-content {
            margin-left: var(--sidebar-width);
            /* Push content key */
        }

        .sidebar-header {
            padding-bottom: 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .brand-text {
            font-size: 28px;
            font-weight: 700;
            color: #fff;
            background: transparent;
            padding: 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            letter-spacing: 1px;
        }

        .brand-text i {
            margin-right: 10px;
            color: var(--accent-color);
        }

        .menu-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .menu-item {
            margin-bottom: 15px;
        }

        .menu-link {
            display: flex;
            align-items: center;
            padding: 14px 20px;
            color: rgba(255, 255, 255, 0.85);
            text-decoration: none;
            font-size: 16px;
            background: transparent;
            border-radius: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 0;
        }

        .menu-link:hover,
        .menu-link.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .menu-link i {
            margin-right: 15px;
            width: 24px;
            text-align: center;
            font-size: 1.1rem;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 40px 50px;
            overflow-y: auto;
        }

        /* Dashboard Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 25px;
            margin-bottom: 50px;
        }

        .stat-card {
            padding: 25px;
            border-radius: 20px;
            background: var(--bg-glass);
            border: var(--border-glass);
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-direction: row;
            /* Icon left, text right */
            align-items: center;
            justify-content: space-between;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            height: auto;
            min-height: 140px;
        }

        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        /* Icon wrapper for stats */
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        /* Card Colors (Gradients) */
        .card-green .stat-icon {
            background: linear-gradient(135deg, #43A047, #66BB6A);
        }

        .card-orange .stat-icon {
            background: linear-gradient(135deg, #FB8C00, #FFA726);
        }

        .card-blue .stat-icon {
            background: linear-gradient(135deg, #1E88E5, #42A5F5);
        }

        .card-red .stat-icon {
            background: linear-gradient(135deg, #E53935, #EF5350);
        }

        .stat-info {
            text-align: right;
        }

        .stat-title {
            font-size: 16px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: #333;
            line-height: 1.2;
        }

        /* Table Section */
        .content-panel {
            background: var(--bg-glass);
            border-radius: 24px;
            padding: 35px;
            box-shadow: var(--shadow-soft);
            border: var(--border-glass);
            margin-bottom: 30px;
            overflow: hidden;
        }

        h2 {
            color: #1B5E20 !important;
            /* Force dark green */
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 25px;
            text-shadow: none;
        }

        /* Bottom Floating Button */
        .floating-action-bar {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            /* Boost z-index to avoid being covered */
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
        }

        thead th {
            text-align: left;
            padding: 18px 25px;
            color: #2E7D32;
            /* Dark green for headers */
            font-weight: 600;
            border-bottom: 2px solid #E8F5E9;
            background: #F1F8E9;
            /* Light green background for headers */
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        thead th:first-child {
            border-top-left-radius: 12px;
            border-bottom-left-radius: 12px;
        }

        thead th:last-child {
            border-top-right-radius: 12px;
            border-bottom-right-radius: 12px;
        }

        tbody tr {
            background-color: rgba(255, 255, 255, 0.7);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.02);
            transition: all 0.2s ease;
            cursor: default;
        }

        tbody tr:hover {
            transform: scale(1.01);
            background-color: rgba(255, 255, 255, 0.95);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            background: rgba(255, 255, 255, 0.95);
            transform: scale(1.005);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        tbody td {
            padding: 18px 25px;
            color: #000;
            /* Pure black for maximum contrast */
            border-bottom: 1px solid #ddd;
            /* Slightly darker border */
            font-size: 1rem;
            /* Larger font */
            font-weight: 500;
            /* Bolder text */
            vertical-align: middle;
        }

        tbody td:first-child {
            border-top-left-radius: 15px;
            border-bottom-left-radius: 15px;
        }

        tbody td:last-child {
            border-top-right-radius: 15px;
            border-bottom-right-radius: 15px;
        }

        /* Status Badges */
        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: capitalize;
            display: inline-block;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .status-pending {
            background: #FFF3E0;
            color: #E65100;
            border: 1px solid #FFE0B2;
        }

        .status-confirmed,
        .status-paid {
            background: #E8F5E9;
            color: #2E7D32;
            border: 1px solid #C8E6C9;
        }

        .status-shipped {
            background: #E3F2FD;
            color: #1565C0;
            border: 1px solid #BBDEFB;
        }

        .status-cancelled {
            background: #FFEBEE;
            color: #C62828;
            border: 1px solid #FFCDD2;
        }

        /* Action Buttons */
        .btn-action {
            padding: 10px 24px;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            color: white;
            margin-right: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
            filter: brightness(1.05);
        }

        .btn-blue {
            background: linear-gradient(135deg, #1E88E5, #42A5F5);
        }

        /* View Details */
        .btn-orange {
            background: linear-gradient(135deg, #FF6F00, #FF8F00);
        }

        /* Confirm */
        .btn-red {
            background: linear-gradient(135deg, #D32F2F, #E57373);
        }

        /* Undo/Cancel */
        .btn-brown {
            background: linear-gradient(135deg, #5D4037, #8D6E63);
        }

        .btn-green {
            background: var(--primary-gradient);
        }

        /* Bottom Floating Button */
        .floating-action-bar {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
        }

        .btn-large-add {
            background: var(--primary-gradient);
            color: white;
            font-size: 18px;
            font-weight: 600;
            padding: 16px 50px;
            border-radius: 50px;
            border: 4px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 10px 30px rgba(46, 125, 50, 0.4);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn-large-add:hover {
            transform: translateX(-50%) scale(1.05);
            box-shadow: 0 15px 40px rgba(46, 125, 50, 0.5);
        }

        .btn-large-add::before {
            content: '+';
            font-size: 24px;
            font-weight: bold;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Kanit', sans-serif;
            box-sizing: border-box;
        }
    </style>
    <!-- SweetAlert2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-material-ui/material-ui.min.css" rel="stylesheet">
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>

    <div class="admin-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <span class="brand-text">Admin Panel</span>
            </div>
            <ul class="menu-list">
                <li class="menu-item"><a href="#" onclick="showSection('dashboard')" class="menu-link active"
                        style="color: #000;"><i class="fas fa-home"></i> แดชบอร์ด</a></li>
                <li class="menu-item"><a href="#" onclick="showSection('products')" class="menu-link"
                        style="color: #000;"><i class="fas fa-seedling"></i> จัดการสินค้า/ต้นกล้า</a></li>
                <li class="menu-item"><a href="#" onclick="showSection('orders')" class="menu-link"
                        style="color: #000;"><i class="fas fa-calendar-alt"></i> จัดการคำสั่งซื้อ</a></li>
                <li class="menu-item"><a href="#" onclick="showSection('payments')" class="menu-link"
                        style="color: #000;"><i class="fas fa-credit-card"></i> การชำระเงิน</a></li>
                <li class="menu-item"><a href="#" onclick="showSection('history')" class="menu-link"
                        style="color: #000;"><i class="fas fa-history"></i> ประวัติการขาย</a></li>
                <li class="menu-item"><a href="#" onclick="showSection('users')" class="menu-link"
                        style="color: #000;"><i class="fas fa-user"></i> ผู้ใช้งาน</a></li>
                <li class="menu-item"><a href="#" onclick="showSection('reports')" class="menu-link"
                        style="color: #000;"><i class="fas fa-envelope"></i> ข้อความจากทางบ้าน</a></li>
                <br>
                <li class="menu-item"><a href="../index.html" class="menu-link" style="color: #000;"><i
                            class="fas fa-external-link-alt"></i> ไปหน้าบ้าน</a></li>
                <li class="menu-item"><a href="#" onclick="logout()" class="menu-link" style="color: #000;"><i
                            class="fas fa-power-off" style="color: #ff5252;"></i>
                        ออกจากระบบ</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">

            <!-- Stats -->
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card card-green">
                    <div class="stat-icon"><i class="fas fa-seedling"></i></div>
                    <div class="stat-info">
                        <div class="stat-title">ยอดคงเหลือรวม (ถาด)</div>
                        <div class="stat-value" id="stats-products">0</div>
                    </div>
                </div>
                <div class="stat-card card-blue"> <!-- Changed from card-green to separate color -->
                    <div class="stat-icon"><i class="fas fa-shopping-cart"></i></div>
                    <div class="stat-info">
                        <div class="stat-title">คำสั่งซื้อวันนี้</div>
                        <div class="stat-value" id="stats-orders-today">0</div>
                    </div>
                </div>
                <div class="stat-card card-orange">
                    <div class="stat-icon"><i class="fas fa-clock"></i></div>
                    <div class="stat-info">
                        <div class="stat-title">รอการชำระเงิน</div>
                        <div class="stat-value" id="stats-pending">0</div>
                    </div>
                </div>
                <div class="stat-card card-green">
                    <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="stat-info">
                        <div class="stat-title">สั่งซื้อสำเร็จ</div>
                        <div class="stat-value" id="stats-completed">0</div>
                    </div>
                </div>
                <div class="stat-card card-blue" style="background: linear-gradient(135deg, #42a5f5, #1976d2);">
                    <div class="stat-icon"><i class="fas fa-users"></i></div>
                    <div class="stat-info">
                        <div class="stat-title">กำลังใช้งาน (Online)</div>
                        <div class="stat-value" id="stats-online">0</div>
                    </div>
                </div>
            </div>

            <!-- Chart Section -->
            <div class="content-panel" style="margin-bottom: 20px;">
                <h2 style="margin-top:0;">สรุปยอดขายรายเดือน</h2>
                <div style="height: 300px;">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>

            <!-- Dynamic Content Area -->
            <div id="dashboard-view" class="content-panel">
                <h2 style="margin-top:0;">รายการคำสั่งซื้อล่าสุด (รอการจัดการ)</h2>
                <table>
                    <thead>
                        <tr>
                            <th>เลขที่คำสั่งซื้อ</th>
                            <th>ชื่อลูกค้า</th>
                            <th>วันที่เริ่มผลิตกล้า</th>
                            <th>สถานะ</th>
                            <th>รายละเอียด</th>
                            <th>ยืนยันคำสั่งซื้อ</th>
                        </tr>
                    </thead>
                    <tbody id="dashboard-table-body">
                        <!-- Loaded via JS -->
                        <tr>
                            <td colspan="6" style="text-align:center;">กำลังโหลด...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- History View (Hidden by default) -->
            <div id="history-view" class="content-panel" style="display:none;">
                <h2 style="margin-top:0;">ประวัติการขาย (เสร็จสิ้น)</h2>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ลูกค้า</th>
                                <th>วันที่ขาย</th>
                                <th>ยอดรวม</th>
                                <th>สถานะ</th>
                                <th>จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Products View (Hidden by default) -->
            <div id="products-view" class="content-panel" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2 style="margin-top:0;">จัดการต้นกล้า</h2>
                    <button onclick="showProductModal()" class="btn-action btn-blue"><i class="fas fa-plus"></i>
                        เพิ่มต้นกล้า</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>รูปภาพ</th>
                            <th>ชื่อพันธุ์ข้าว</th>
                            <th>ราคา</th>
                            <th>คงเหลือ</th>
                            <th>จัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="products-table-body"></tbody>
                </table>
            </div>

            <!-- Orders View (Hidden by default) -->
            <div id="orders-view" class="content-panel" style="display:none;">
                <h2 style="margin-top:0;">จัดการคำสั่งซื้อทั้งหมด</h2>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ลูกค้า</th>
                            <th>วันที่สั่งซื้อ</th>
                            <th>ยอดรวม</th>
                            <th>สถานะ</th>
                            <th>จัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="orders-table-body"></tbody>
                </table>
            </div>

            <!-- Users View (Hidden by default) -->
            <div id="users-view" class="content-panel" style="display:none;">
                <h2 style="margin-top:0;">ผู้ใช้งานระบบ</h2>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ชื่อผู้ใช้</th>
                                <th>อีเมล</th>
                                <th>เบอร์โทร</th>
                                <th>สิทธิ์</th>
                                <th>วันที่สมัคร</th>
                                <th>จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Reports View (Hidden by default) -->
            <div id="reports-view" class="content-panel" style="display:none;">
                <h2 style="margin-top:0;">ข้อความจากทางบ้าน (Reports)</h2>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>วันที่</th>
                                <th>ชื่อผู้ส่ง</th>
                                <th>ติดต่อกลับ</th>
                                <th>หัวข้อ</th>
                                <th>ข้อความ</th>
                            </tr>
                        </thead>
                        <tbody id="reports-table-body"></tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <!-- Floating Button removed as per request -->

    <!-- Order Details Modal -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <h2>รายละเอียดคำสั่งซื้อ</h2>
            <div id="orderDetailsContent"></div>
            <div style="margin-top:20px; text-align:right;">
                <button type="button" class="btn-action btn-red" onclick="closeModals()">ปิด</button>
            </div>
        </div>
    </div>

    <!-- User Role Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <h2>จัดการสิทธิ์ผู้ใช้งาน</h2>
            <form id="userForm" onsubmit="handleUserSubmit(event)">
                <input type="hidden" id="userId">
                <div class="form-group">
                    <p><strong>ชื่อผู้ใช้:</strong> <span id="userNameDisplay"></span></p>
                    <p><strong>อีเมล:</strong> <span id="userEmailDisplay"></span></p>
                </div>
                <div class="form-group">
                    <label>ระดับสิทธิ์ (Role)</label>
                    <select id="userRole" class="form-control"
                        style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
                        <option value="user">User (ผู้ใช้ทั่วไป)</option>
                        <option value="admin">Admin (ผู้ดูแลระบบ)</option>
                    </select>
                </div>
                <div style="text-align:right; margin-top:20px;">
                    <button type="button" class="btn-action btn-red" onclick="closeModals()">ยกเลิก</button>
                    <button type="submit" class="btn-action btn-green">บันทึก</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <h2 id="productModalTitle">เพิ่มต้นกล้าใหม่</h2>
            <form id="productForm" onsubmit="handleProductSubmit(event)">
                <input type="hidden" id="productId">
                <div class="form-group">
                    <label>ชื่อพันธุ์ข้าว</label>
                    <input type="text" id="productName" required>
                </div>
                <div class="form-group">
                    <label>ราคาต่อหน่วย</label>
                    <input type="number" id="productPrice" required>
                </div>
                <div class="form-group">
                    <label>จำนวนคงเหลือ</label>
                    <input type="number" id="productStock" required>
                </div>
                <div class="form-group">
                    <label>ลิงก์รูปภาพ</label>
                    <input type="text" id="productImage">
                </div>
                <div class="form-group">
                    <label>หมวดหมู่</label>
                    <input type="text" id="productCategory">
                </div>
                <div class="form-group">
                    <label>รายละเอียด</label>
                    <textarea id="productDesc"></textarea>
                </div>
                <div style="text-align:right;">
                    <button type="button" class="btn-action btn-red" onclick="closeModals()">ยกเลิก</button>
                    <button type="submit" class="btn-action btn-green"
                        style="background-color: var(--primary-color);">บันทึก</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../js/api-client.js"></script>
    <script>
        // State
        let allOrders = [];
        let allProducts = [];
        let allUsers = [];

        // Initialization
        document.addEventListener('DOMContentLoaded', async () => {
            // BYPASS AUTH CHECK FOR DEMO
            console.log('Bypassing auth check...');
            await refreshData();
        });

        async function refreshData() {
            try {
                const token = api.getToken();

                // Try to fetch real data if token exists, otherwise fall back to mock
                if (token) {
                    try {
                        allOrders = await api.getAdminOrders();
                        allProducts = await api.getProducts();
                        const stats = await api.getStats();
                        window.latestStats = stats; // Store for updateStats
                    } catch (e) {
                        console.warn('API failed', e);
                        allOrders = [];
                        allProducts = [];
                    }
                } else {
                    console.warn('No token found');
                    // Redirect to login or just show empty
                    allOrders = [];
                    allProducts = [];
                }

                // Update Stats
                updateStats();

                // Render Default View (Dashboard)
                renderDashboardTable(allOrders);
                renderSalesChart(); // Init chart


            } catch (error) {
                console.error("Failed to load data", error);
                // Fallback to empty data on error
                allOrders = [];
                allProducts = [];
                updateStats();
                renderDashboardTable(allOrders);
            }
        }

        // Mock data function removed as per user request

        function updateStats() {
            // Count Products (Total Stock)
            const totalStock = allProducts.reduce((sum, p) => sum + (parseInt(p.stock) || 0), 0);
            document.getElementById('stats-products').innerText = totalStock.toLocaleString();

            // Count Orders (Today)
            const today = new Date().toISOString().split('T')[0];
            const ordersToday = allOrders.filter(o => o.order_date.startsWith(today)).length;
            document.getElementById('stats-orders-today').innerText = ordersToday;

            // Count Pending
            const pending = allOrders.filter(o => o.status === 'pending').length;
            document.getElementById('stats-pending').innerText = pending;

            // Count Completed (confirmed/delivered)
            const completed = allOrders.filter(o => ['confirmed', 'shipped', 'delivered'].includes(o.status)).length;
            document.getElementById('stats-completed').innerText = completed;

            // Online Users
            if (window.latestStats && window.latestStats.onlineUsers !== undefined) {
                document.getElementById('stats-online').innerText = window.latestStats.onlineUsers;
            } else {
                document.getElementById('stats-online').innerText = '-';
            }
        }

        // Render Functions
        let salesChartInstance = null;

        async function renderSalesChart() {
            const ctx = document.getElementById('salesChart').getContext('2d');

            // Fetch data
            let salesData = [];
            try {
                salesData = await api.getSalesMonthly();
            } catch (e) {
                console.error("Failed to load sales data", e);
            }

            // Transform data for Chart.js
            // Data comes as [{ month: '2024-02', total: 1000 }, ...]
            // improved: fill missing months? For now, just show what we have.

            const labels = salesData.map(d => {
                const [y, m] = d.month.split('-');
                const date = new Date(y, m - 1);
                return date.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' });
            });
            const data = salesData.map(d => d.total);

            if (salesChartInstance) {
                salesChartInstance.destroy();
            }

            salesChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ยอดขายรายเดือน (บาท)',
                        data: data,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderDashboardTable(orders) {
            const tbody = document.getElementById('dashboard-table-body');
            tbody.innerHTML = '';

            // Filter out 'completed' orders from dashboard (active orders only)
            // or show recent ones? Requirement: Completed go to history.
            // Let's filter active orders for dashboard "Recent Orders"
            const activeOrders = orders.filter(o => o.status !== 'completed');
            const recentOrders = activeOrders.slice(0, 10);

            recentOrders.forEach(order => {
                const tr = document.createElement('tr');

                // Status Badge Logic
                let badgeClass = 'badge-pending';
                let statusText = 'รอการชำระเงิน';

                if (order.status === 'confirmed' || order.status === 'shipped') {
                    badgeClass = 'badge-confirmed';
                    statusText = 'สั่งซื้อสำเร็จ'; // Or specific status text
                } else if (order.status === 'cancelled') {
                    badgeClass = 'badge-cancelled';
                    statusText = 'ยกเลิกแล้ว';
                }

                // Override status text with actual status if needed
                if (order.status === 'confirmed') statusText = 'ยืนยันแล้ว';
                if (order.status === 'shipped') statusText = 'จัดส่งแล้ว';

                const date = new Date(order.order_date);
                const dateStr = date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' });

                tr.innerHTML = `
                    <td>#${order.order_id}</td>
                    <td>${order.full_name || 'ลูกค้าทั่วไป'}</td>
                    <td>${dateStr}</td>
                    <td><span class="badge ${badgeClass}">${statusText}</span></td>
                    <td>
                        <button class="btn-action btn-blue" onclick="viewOrderDetails(${order.order_id})">ดูรายละเอียด</button>
                        ${order.status === 'pending' ?
                        `<button class="btn-action btn-orange" onclick="updateStatus(${order.order_id}, 'confirmed')">ยืนยันคำสั่งซื้อ</button>` :
                        (order.status === 'confirmed' || order.status === 'shipped' ?
                            `<button class="btn-action btn-green" onclick="handleCompleteSale(${order.order_id})">จบการขาย</button>` :
                            (order.status === 'cancelled' ? `<button class="btn-action btn-brown" disabled>ยกเลิกแล้ว</button>` : '')
                        )
                    }
                        <button class="btn-action btn-red" onclick="deleteOrder(${order.order_id})">
                            <i class="fas fa-trash"></i> ลบ
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderHistoryTable() {
            const tbody = document.getElementById('history-table-body');
            tbody.innerHTML = '';

            // Filter only completed
            const completedOrders = allOrders.filter(o => o.status === 'completed');

            completedOrders.forEach(o => {
                const tr = document.createElement('tr');
                const dateStr = new Date(o.order_date).toLocaleDateString('th-TH');
                tr.innerHTML = `
                    <td>${o.order_id}</td>
                    <td>${o.full_name}</td>
                    <td>${dateStr}</td>
                    <td>
                        <div>฿${o.total_price.toLocaleString()}</div>
                        ${o.payment_type === 'deposit' ?
                        `<small style="color:#d32f2f;">(มัดจำ: ฿${Math.round(o.paid_amount).toLocaleString()})</small>` :
                        `<small style="color:#388e3c;">(จ่ายเต็ม)</small>`
                    }
                    </td>
                    <td><span class="status-badge" style="background:#e8f5e9; color:#2e7d32;">เสร็จสิ้น</span></td>
                    <td>
                        <button class="btn-action btn-blue" onclick="viewOrderDetails(${o.order_id})">ดู</button>
                    </td>
                 `;
                tbody.appendChild(tr);
            });
        }

        function renderProductsTable() {
            const tbody = document.getElementById('products-table-body');
            tbody.innerHTML = '';

            if (!allProducts || allProducts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">ไม่พบข้อมูลสินค้า</td></tr>';
                return;
            }

            allProducts.forEach(p => {
                const tr = document.createElement('tr');
                // Use a default image if none provided
                const imgUrl = p.image_url && p.image_url.trim() !== '' ? p.image_url : '../images/no-image.png';

                tr.innerHTML = `
                    <td>${p.product_id}</td>
                    <td><img src="${imgUrl}" style="width:50px; height:50px; object-fit:cover; border-radius:8px; border:1px solid #eee;" onerror="this.src='../images/no-image.png'"></td>
                    <td>${p.product_name}</td>
                    <td>฿${parseFloat(p.price).toLocaleString()}</td>
                    <td>
                        <span class="status-badge" style="background:${p.stock > 10 ? '#e8f5e9' : '#ffebee'}; color:${p.stock > 10 ? '#2e7d32' : '#c62828'};">
                            ${p.stock.toLocaleString()}
                        </span>
                    </td>
                    <td>
                        <button class="btn-action btn-blue" onclick="editProduct(${p.product_id})">
                            <i class="fas fa-edit"></i> แก้ไข
                        </button>
                        <button class="btn-action btn-red" onclick="deleteProduct(${p.product_id})">
                            <i class="fas fa-trash"></i> ลบ
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderOrdersTable() {
            const tbody = document.getElementById('orders-table-body');
            tbody.innerHTML = '';

            // Show all orders except completed? Or all? Usually "Orders" manages active ones.
            // Let's hide completed from here too to avoid clutter, or keep them?
            // User requested "Completed users go to sales history". So distinct view.
            const activeOrders = allOrders.filter(o => o.status !== 'completed');

            activeOrders.forEach(o => {
                const tr = document.createElement('tr');
                const dateStr = new Date(o.order_date).toLocaleDateString('th-TH');
                tr.innerHTML = `
                    <td>${o.order_id}</td>
                    <td>${o.full_name}</td>
                    <td>${dateStr}</td>
                    <td>
                        <div>฿${o.total_price.toLocaleString()}</div>
                        ${o.payment_type === 'deposit' ?
                        `<small style="color:#d32f2f;">(มัดจำ: ฿${Math.round(o.paid_amount).toLocaleString()})</small>` :
                        `<small style="color:#388e3c;">(จ่ายเต็ม)</small>`
                    }
                    </td>
                    <td><span class="status-badge status-${o.status}">${o.status}</span></td>
                    <td>
                        <button class="btn-action btn-blue" onclick="viewOrderDetails(${o.order_id})">ดู</button>
                        ${o.status === 'pending' ?
                        `<button class="btn-action btn-orange" onclick="updateStatus(${o.order_id}, 'confirmed')">ยืนยัน</button>` :
                        (o.status === 'confirmed' || o.status === 'shipped' ?
                            `<button class="btn-action btn-green" onclick="handleCompleteSale(${o.order_id})">จบการขาย</button>` : '')
                    }
                    </td>
                 `;
                tbody.appendChild(tr);
            });
        }


        async function loadUsers() {
            try {
                allUsers = await api.getAdminUsers();
                const tbody = document.getElementById('users-table-body');
                tbody.innerHTML = '';
                allUsers.forEach(u => {
                    const tr = document.createElement('tr');
                    const dateStr = u.created_at ? new Date(u.created_at).toLocaleDateString('th-TH') : '-';
                    const phoneStr = u.phone || '-';
                    tr.innerHTML = `
                        <td>${u.user_id}</td>
                        <td>${u.username}</td>
                        <td>${u.email}</td>
                        <td>${phoneStr}</td>
                        <td>
                            <span class="status-badge status-${u.role === 'admin' ? 'shipped' : 'pending'}" 
                                  style="background-color: ${u.role === 'admin' ? '#e8f5e9' : '#f5f5f5'}; color: ${u.role === 'admin' ? '#2e7d32' : '#616161'}">
                                ${u.role}
                            </span>
                        </td>
                        <td>${dateStr}</td>
                        <td>
                            <button class="btn-action btn-blue" onclick='showUserModal(${JSON.stringify(u)})'>แก้ไข</button>
                            <button class="btn-action btn-red" onclick="deleteUser(${u.user_id})">ลบ</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error("Error loading users:", e);
                // Optional: Swal.fire('Error', 'Failed to load users', 'error');
            }
        }

        async function deleteUser(id) {
            const result = await Swal.fire({
                title: 'ยืนยันการลบบัญชี?',
                text: "คุณต้องการลบผู้ใช้นี้ใช่หรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'ลบบัญชี',
                cancelButtonText: 'ยกเลิก'
            });

            if (!result.isConfirmed) return;

            try {
                await api.deleteUser(id);
                await Swal.fire(
                    'ลบเรียบร้อย!',
                    'บัญชีผู้ใช้ถูกลบออกจากระบบแล้ว.',
                    'success'
                );
                loadUsers();
                updateStats(); // Update stats if relevant
            } catch (e) {
                Swal.fire('Error', e.message, 'error');
            }
        }

        async function renderReportsTable() {
            const tbody = document.getElementById('reports-table-body');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">กำลังโหลด...</td></tr>';

            try {
                const reports = await api.getReports();
                tbody.innerHTML = '';

                if (!reports || reports.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">ไม่มีข้อความ</td></tr>';
                    return;
                }

                reports.forEach(r => {
                    const tr = document.createElement('tr');
                    const dateStr = new Date(r.created_at).toLocaleString('th-TH');
                    tr.innerHTML = `
                        <td>${dateStr}</td>
                        <td>${r.name}</td>
                        <td>${r.contact}</td>
                        <td><span class="status-badge" style="background:#e3f2fd; color:#1976d2;">${r.category}</span></td>
                        <td>${r.message}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="5" style="color:red; text-align:center;">Error: ${error.message}</td></tr>`;
            }
        }

        // Actions
        async function handleCompleteSale(orderId) {
            const result = await Swal.fire({
                title: 'ยืนยันการจบการขาย?',
                text: "สถานะจะเปลี่ยนเป็น 'เสร็จสิ้น' และย้ายไปยังประวัติการขาย",
                icon: 'success',
                showCancelButton: true,
                confirmButtonText: 'ยืนยัน',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: '#2E7D32'
            });

            if (!result.isConfirmed) return;

            try {
                await api.updateOrderStatus(orderId, 'completed');
                await Swal.fire({
                    icon: 'success',
                    title: 'จบการขายสำเร็จ!',
                    text: 'คำสั่งซื้อนี้ถูกย้ายไปยัง "ประวัติการขาย" แล้ว',
                    timer: 2000,
                    showConfirmButton: false
                });
                refreshData();
            } catch (error) {
                console.error('Error completing sale:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: error.message
                });
            }
        }

        async function updateStatus(orderId, newStatus) {
            // ... (keep existing Swal if standard update, but for handleCompleteSale we already asked)
            // But reuse of updateStatus might trigger another Swal if not careful.
            // Let's modify updateStatus to be generic or just call api directly here if we want to avoid double prompt.
            // However, the existing updateStatus has a prompt inside.
            // Let's just use api directly in handleCompleteSale to avoid double prompt, OR refactor updateStatus.
            // For simplicity, let's
            try {
                await api.updateOrderStatus(orderId, newStatus);
                await Swal.fire({
                    icon: 'success',
                    title: 'สำเร็จ!',
                    text: 'อัปเดตสถานะเรียบร้อยแล้ว',
                    timer: 1500,
                    showConfirmButton: false
                });
                await refreshData();
            } catch (err) {
                Swal.fire('Error', err.message, 'error');
            }
        }

        async function deleteOrder(orderId) {
            const result = await Swal.fire({
                title: 'ยืนยันการลบ?',
                text: "คุณต้องการลบคำสั่งซื้อนี้ใช่หรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'ใช่, ลบเลย!',
                cancelButtonText: 'ยกเลิก'
            });

            if (result.isConfirmed) {
                try {
                    await api.deleteOrder(orderId);
                    await Swal.fire(
                        'ลบสำเร็จ!',
                        'คำสั่งซื้อถูกลบเรียบร้อยแล้ว.',
                        'success'
                    );
                    refreshData();
                } catch (error) {
                    console.error("Error deleting order:", error);
                    Swal.fire(
                        'เกิดข้อผิดพลาด!',
                        'ไม่สามารถลบคำสั่งซื้อได้: ' + error.message,
                        'error'
                    );
                }
            }
        }

        // Navigation
        function showSection(section) {
            // Hide all
            document.querySelectorAll('.content-panel').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.menu-link').forEach(el => el.classList.remove('active'));

            // Show Target
            if (section === 'dashboard') {
                document.getElementById('dashboard-view').style.display = 'block';
                document.querySelectorAll('.menu-link')[0].classList.add('active');
                renderSalesChart(); // Render chart on dashboard
            } else if (section === 'products') {
                document.getElementById('products-view').style.display = 'block';
                document.querySelectorAll('.menu-link')[1].classList.add('active');
                renderProductsTable();
            } else if (section === 'orders') {
                document.getElementById('orders-view').style.display = 'block';
                document.querySelectorAll('.menu-link')[2].classList.add('active');
                renderOrdersTable();
            } else if (section === 'payments') {
                document.getElementById('orders-view').style.display = 'block';
                document.querySelectorAll('.menu-link')[3].classList.add('active');
                renderOrdersTable();
            } else if (section === 'history') { // New Section
                document.getElementById('history-view').style.display = 'block';
                document.querySelectorAll('.menu-link')[4].classList.add('active');
                renderHistoryTable();
            } else if (section === 'users') {
                document.getElementById('users-view').style.display = 'block';
                document.querySelectorAll('.menu-link')[5].classList.add('active'); // Shifted index
                loadUsers();
            } else if (section === 'reports') {
                document.getElementById('reports-view').style.display = 'block';
                document.querySelectorAll('.menu-link')[6].classList.add('active'); // Shifted index
                renderReportsTable();
            } else {
                alert('Section coming soon: ' + section);
            }
        }

        // Modals
        function showProductModal(product = null) {
            const modal = document.getElementById('productModal');
            const form = document.getElementById('productForm');

            if (product) {
                document.getElementById('productModalTitle').innerText = 'แก้ไขต้นกล้า';
                document.getElementById('productId').value = product.product_id;
                document.getElementById('productName').value = product.product_name;
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productStock').value = product.stock;
                document.getElementById('productImage').value = product.image_url || '';
                document.getElementById('productCategory').value = product.category || '';
                document.getElementById('productDesc').value = product.description || '';
            } else {
                document.getElementById('productModalTitle').innerText = 'เพิ่มต้นกล้าใหม่';
                form.reset();
                document.getElementById('productId').value = '';
            }
            modal.classList.add('active');
        }

        function closeModals() {
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
        }

        async function handleProductSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('productId').value;
            const name = document.getElementById('productName').value;
            const price = document.getElementById('productPrice').value;
            const stock = document.getElementById('productStock').value;
            const image = document.getElementById('productImage').value;
            const category = document.getElementById('productCategory').value;
            const desc = document.getElementById('productDesc').value;

            try {
                if (id) {
                    await api.updateProduct(id, name, desc, category, price, stock, image);
                } else {
                    await api.createProduct(name, desc, category, price, stock, image);
                }
                closeModals();
                await refreshData();
                if (document.getElementById('products-view').style.display === 'block') {
                    renderProductsTable();
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        function editProduct(id) {
            const p = allProducts.find(x => x.product_id == id);
            if (p) showProductModal(p);
        }

        async function deleteProduct(id) {
            const result = await Swal.fire({
                title: 'ยืนยันการลบ?',
                text: "คุณจะลบสินค้านี้ใช่หรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'ลบสินค้า'
            });

            if (!result.isConfirmed) return;

            try {
                await api.deleteProduct(id);
                await Swal.fire(
                    'ลบเรียบร้อย!',
                    'สินค้าถูกลบออกจากระบบแล้ว.',
                    'success'
                );
                await refreshData();
                if (document.getElementById('products-view').style.display === 'block') {
                    renderProductsTable();
                }
            } catch (e) {
                Swal.fire('Error', e.message, 'error');
            }
        }

        // --- User Management ---
        function showUserModal(user) {
            document.getElementById('userId').value = user.user_id;
            document.getElementById('userNameDisplay').innerText = user.username;
            document.getElementById('userEmailDisplay').innerText = user.email;
            document.getElementById('userRole').value = user.role;
            document.getElementById('userModal').classList.add('active');
        }

        async function handleUserSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('userId').value;
            const role = document.getElementById('userRole').value;

            try {
                await api.updateUserRole(id, role);
                await Swal.fire({
                    icon: 'success',
                    title: 'สำเร็จ',
                    text: 'อัปเดตสิทธิ์เรียบร้อย',
                    timer: 1500,
                    showConfirmButton: false
                });
                closeModals();
                await loadUsers(); // Reload table
            } catch (error) {
                Swal.fire('Error', error.message, 'error');
            }
        }

        async function viewOrderDetails(id) {
            // Fetch fresh data if needed, or use local. Best to fetch fresh order details to get items.
            // Existing logic uses allOrders find, but that might not have items.
            // Let's use api.getOrder(id) as per my previous plan, it returns items too.
            try {
                const order = await api.getOrder(id);
                // order object from api.getOrder returns { ...orderFields, items: [] }

                const content = document.getElementById('orderDetailsContent');
                const date = new Date(order.order_date);
                const dateStr = date.toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' });

                let paymentInfo = '';
                if (order.payment_type === 'deposit') {
                    const remaining = order.total_price - order.paid_amount;
                    paymentInfo = `
                        <div style="margin-top:10px; padding:10px; background:#ffebee; border-radius:5px; border:1px solid #ffcdd2;">
                            <p style="color:#c62828; font-weight:bold;"><i class="fas fa-exclamation-circle"></i> การชำระเงิน: มัดจำ (50%)</p>
                            <p>จ่ายแล้ว: ฿${Math.round(order.paid_amount).toLocaleString()}</p>
                            <p style="font-size:1.1em; font-weight:bold;">ค้างชำระ: ฿${Math.round(remaining).toLocaleString()}</p>
                        </div>
                    `;
                } else {
                    paymentInfo = `
                        <div style="margin-top:10px; padding:10px; background:#e8f5e9; border-radius:5px; border:1px solid #c8e6c9;">
                            <p style="color:#2e7d32; font-weight:bold;"><i class="fas fa-check-circle"></i> การชำระเงิน: จ่ายเต็มจำนวน</p>
                            <p>ยอดรวม: ฿${order.total_price.toLocaleString()}</p>
                        </div>
                    `;
                }

                let html = `
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div>
                            <h3>ข้อมูลลูกค้า</h3>
                            <p><strong>ชื่อ:</strong> ${order.full_name}</p>
                            <p><strong>เบอร์โทร:</strong> ${order.phone || '-'}</p>
                            <p><strong>ที่อยู่จัดส่ง:</strong><br>${order.shipping_address}</p>
                            <p><strong>วันที่สั่งซื้อ:</strong> ${dateStr}</p>
                        </div>
                        <div>
                            <h3>หลักฐานการโอนเงิน</h3>
                            ${paymentInfo}
                            ${order.payment_slip ?
                        `<div>
                                    <p><strong>สลิปการโอน:</strong></p>
                                    <img src="${order.payment_slip}" style="max-width:100%; border-radius:5px; border:1px solid #ddd; cursor:pointer;" onclick="window.open(this.src)">
                                </div>` :
                        '<p style="color:#999;">ไม่มีหลักฐานการโอน</p>'
                    }
                        </div>
                    </div>
                    <h3>รายการสินค้า</h3>
                    <table style="width:100%; border-collapse: collapse; margin-top:10px;">
                        <tr style="background:#f5f5f5; text-align:left;">
                            <th style="padding:8px;">สินค้า</th>
                            <th style="padding:8px;">ราคา</th>
                            <th style="padding:8px;">จำนวน</th>
                            <th style="padding:8px;">รวม</th>
                        </tr>
                `;

                if (order.items) {
                    order.items.forEach(item => {
                        html += `
                            <tr style="border-bottom:1px solid #ddd;">
                                <td style="padding:8px;">
                                    <div style="display:flex; align-items:center;">
                                        <img src="${item.image_url}" style="width:40px; height:40px; margin-right:10px; object-fit:cover;">
                                        ${item.product_name}
                                    </div>
                                </td>
                                <td style="padding:8px;">฿${item.price}</td>
                                <td style="padding:8px;">${item.quantity}</td>
                                <td style="padding:8px;">฿${item.price * item.quantity}</td>
                            </tr>
                        `;
                    });
                }

                html += `
                        <tr style="font-weight:bold; background:#fafafa;">
                            <td colspan="3" style="text-align:right; padding:8px;">ราคารวมทั้งหมด</td>
                            <td style="padding:8px;">฿${order.total_price.toLocaleString()}</td>
                        </tr>
                    </table>
                `;

                content.innerHTML = html;
                document.getElementById('orderModal').classList.add('active');
            } catch (e) {
                console.error(e);
                alert("เกิดข้อผิดพลาดในการดึงข้อมูล");
            }
        }

        function logout() {
            Swal.fire({
                title: 'ออกจากระบบ?',
                text: "คุณต้องการออกจากระบบใช่หรือไม่?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'ใช่, ออกจากระบบ'
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.clear();
                    if (window.api) api.clearToken();
                    window.location.href = 'sign-in.html';
                }
            })
        }
        // Call refreshData periodically to keep everything in sync
        setInterval(refreshData, 30000); // Every 30s
    </script>
</body>

</html>