<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyRice - ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f5f5f5;
        }

        .profile-container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .profile-header {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
            margin-bottom: 30px;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            margin: 0 auto 15px;
        }

        .info-group {
            margin-bottom: 20px;
        }

        .info-label {
            font-weight: 500;
            color: #666;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.1rem;
            color: #333;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-edit {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            width: 500px;
            max-width: 90%;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #aaa;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
    </style>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>

    <header class="navbar">
        <div class="container">
            <a href="../" class="logo">üåæ EasyRice</a>
            <button class="hamburger" id="hamburger" onclick="toggleMenu()">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <nav id="navMenu">
                <ul>
                    <li><a href="../">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a></li>
                    <li><a href="product.html">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</a></li>
                    <li><a href="about.html">‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£</a></li>
                    <li><a href="contact.html">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</a></li>
                </ul>
            </nav>
            <a href="sign-in.html" class="btn-signin">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a>
        </div>
    </header>

    <main class="container">
        <div class="profile-container">
            <div class="profile-header">
                <div class="profile-avatar"><i class="fas fa-user"></i></div>
                <h2 id="displayName">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h2>
                <p id="displayRole" style="color: #666;">User</p>
            </div>

            <div class="info-group">
                <div class="info-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
                <div class="info-value"><i class="fas fa-user-tag"></i> <span id="username">...</span></div>
            </div>

            <div class="info-group">
                <div class="info-label">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</div>
                <div class="info-value"><i class="fas fa-envelope"></i> <span id="email">...</span></div>
            </div>

            <div class="info-group">
                <div class="info-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</div>
                <div class="info-value"><i class="fas fa-id-card"></i> <span id="fullName">...</span></div>
            </div>

            <div class="info-group">
                <div class="info-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</div>
                <div class="info-value"><i class="fas fa-phone"></i> <span id="phone">...</span></div>
            </div>

            <button class="btn-edit" onclick="openEditModal()">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</button>

            <!-- Edit Profile Modal -->
            <div id="editProfileModal" class="modal">
                <div class="modal-content">
                    <span class="close-btn" onclick="closeEditModal()">&times;</span>
                    <h2>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h2>
                    <form id="editProfileForm" onsubmit="handleProfileUpdate(event)">
                        <div class="form-group">
                            <label>‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</label>
                            <input type="file" id="editAvatar" accept="image/*">
                        </div>
                        <div class="form-group">
                            <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                            <input type="text" id="editFullName" required>
                        </div>
                        <div class="form-group">
                            <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                            <input type="text" id="editPhone">
                        </div>
                        <div class="form-group">
                            <label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
                            <input type="text" id="editAddress">
                        </div>
                        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
                        <div class="form-group">
                            <label>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)</label>
                            <input type="password" id="editPassword" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà">
                        </div>
                        <button type="submit" class="btn-edit"
                            style="background: var(--primary-color);">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
                    </form>
                </div>
            </div>

            <!-- Order History Section -->
            <div class="profile-header" style="margin-top: 40px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
                <h3><i class="fas fa-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>
            </div>

            <div class="order-history-table" style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; text-align: left; min-width: 600px;">
                    <thead>
                        <tr style="background: #f9f9f9; color: #555;">
                            <th style="padding: 12px;">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</th>
                            <th style="padding: 12px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                            <th style="padding: 12px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                            <th style="padding: 12px;">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
                            <th style="padding: 12px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                        <tr>
                            <td colspan="5" style="text-align:center; padding: 20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
    </main>

    <script src="../js/api-client.js"></script>
    <script src="../js/easyrice.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'sign-in.html';
                return;
            }

            try {
                const user = await api.getCurrentUser();
                window.currentUser = user; // Store for edit modal

                document.getElementById('displayName').innerText = user.full_name || user.username;
                document.getElementById('displayRole').innerText = user.role === 'admin' ? 'Administrator' : 'General User';
                document.getElementById('username').innerText = user.username;
                document.getElementById('email').innerText = user.email;
                document.getElementById('fullName').innerText = user.full_name || '-';
                document.getElementById('phone').innerText = user.phone || '-';

                // Update Avatar if exists
                if (user.profile_picture) {
                    const avatarEl = document.querySelector('.profile-avatar');
                    avatarEl.innerHTML = `<img src="${user.profile_picture}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">`;
                }

                // Load Orders
                loadUserOrders();

            } catch (error) {
                console.error('Failed to load profile:', error);
                alert('Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
                api.clearToken(); // Clear invalid token
                window.location.href = 'sign-in.html';
            }
        });

        async function loadUserOrders() {
            const tbody = document.getElementById('historyBody');

            // Check and update table header if needed
            const theadRow = document.querySelector('.order-history-table thead tr');
            if (theadRow && theadRow.children.length === 5) {
                const th = document.createElement('th');
                th.style.padding = '12px';
                th.innerText = '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î';
                theadRow.appendChild(th);
            }

            try {
                // Fetch orders from API
                const orders = await api.getOrders();

                if (!orders || orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</td></tr>';
                    return;
                }

                tbody.innerHTML = '';
                orders.forEach(order => {
                    const statusInfo = getStatusInfo(order.status);
                    const dateObj = new Date(order.created_at || order.order_date);
                    const dateStr = dateObj.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' });

                    let itemsStr = '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û EasyRice';
                    if (order.items && order.items.length > 0) {
                        itemsStr = order.items.map(i => `${i.product_name} x${i.quantity}`).join(', ');
                    } else if (order.item_count) {
                        itemsStr = `${order.first_product_name}` + (order.item_count > 1 ? ` ‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${order.item_count - 1} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£` : '');
                    }

                    const tr = document.createElement('tr');
                    tr.style.borderBottom = '1px solid #eee';

                    // Safe JSON stringify for onclick
                    const orderJson = JSON.stringify(order).replace(/'/g, "&#39;").replace(/"/g, "&quot;");

                    tr.innerHTML = `
                        <td style="padding: 12px;">#${order.order_id || order.id}</td>
                        <td style="padding: 12px;">${dateStr}</td>
                        <td style="padding: 12px;">${itemsStr}</td>
                        <td style="padding: 12px;">‡∏ø${parseFloat(order.total_price || order.total).toLocaleString()}</td>
                        <td style="padding: 12px;">${statusInfo}</td>
                        <td style="padding: 12px;">
                            <button class="btn-view" onclick='viewOrderDetails(${orderJson})' style="background: #2196F3; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                <i class="fas fa-eye"></i> ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);

                    // Keep the inline remark for immediate visibility
                    if (order.status === 'cancelled' && order.remark) {
                        const remarkTr = document.createElement('tr');
                        remarkTr.style.background = '#fff8f8';
                        remarkTr.innerHTML = `
                            <td colspan="6" style="padding: 10px 15px; color: #d32f2f; font-size: 0.9em; border-bottom: 1px solid #eee;">
                                <i class="fas fa-exclamation-circle"></i> <strong>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å:</strong> ${order.remark}
                            </td>
                        `;
                        tbody.appendChild(remarkTr);
                    }
                });

            } catch (error) {
                console.error("History error:", error);
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}</td></tr>`;
            }
        }

        function viewOrderDetails(order) {
            // Create modal dynamically if distinct
            let modal = document.getElementById('orderDetailModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'orderDetailModal';
                modal.className = 'modal';
                // Add modal HTML structure
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px;">
                        <span class="close-btn" onclick="document.getElementById('orderDetailModal').classList.remove('active')">&times;</span>
                        <h2 style="border-bottom:1px solid #eee; padding-bottom:10px; margin-top:0;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2>
                        <div id="orderDetailBody"></div>
                        <button onclick="document.getElementById('orderDetailModal').classList.remove('active')" style="width:100%; margin-top:15px; padding:10px; background:#ddd; border:none; border-radius:5px; cursor:pointer;">‡∏õ‡∏¥‡∏î</button>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            const body = document.getElementById('orderDetailBody');

            // Items List
            let itemsHtml = '';
            if (order.items && order.items.length) {
                itemsHtml = order.items.map(i => `
                    <div style="display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px dashed #eee;">
                        <span>${i.product_name} x ${i.quantity}</span>
                        <span>‡∏ø${(i.price * i.quantity).toLocaleString()}</span>
                    </div>
                `).join('');
            } else {
                itemsHtml = '<p>‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>';
            }

            // Slip
            let slipHtml = '';
            if (order.payment_slip) {
                slipHtml = `
                    <div style="margin-top:15px; text-align:center;">
                        <p style="font-weight:bold; margin-bottom:5px;">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</p>
                        <a href="${order.payment_slip}" target="_blank">
                            <img src="${order.payment_slip}" style="max-width:100%; max-height:200px; border-radius:5px; border:1px solid #ddd;">
                        </a>
                    </div>
                `;
            } else {
                slipHtml = '<p style="text-align:center; color:#888; margin-top:10px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</p>';
            }

            // Remark in Modal
            let remarkHtml = '';
            if (order.status === 'cancelled' && order.remark) {
                remarkHtml = `
                    <div style="margin-top:15px; padding:10px; background:#ffebee; color:#c62828; border-radius:5px; border:1px solid #ffcdd2;">
                        <strong><i class="fas fa-exclamation-circle"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å:</strong> ${order.remark}
                    </div>
                `;
            }

            body.innerHTML = `
                <div style="margin-bottom:10px;">
                    <strong>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</strong> #${order.order_id || order.id} <br>
                    <strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${new Date(order.created_at || order.order_date).toLocaleString('th-TH')} <br>
                    <strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ${getStatusInfo(order.status)}
                </div>
                <div style="background:#f9f9f9; padding:10px; border-radius:5px;">
                    <strong>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</strong>
                    ${itemsHtml}
                    <div style="display:flex; justify-content:space-between; margin-top:10px; font-weight:bold;">
                        <span>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</span>
                        <span style="color:var(--primary-color);">‡∏ø${parseFloat(order.total_price || order.total).toLocaleString()}</span>
                    </div>
                </div>
                ${remarkHtml}
                ${slipHtml}
            `;

            modal.classList.add('active');
        }

        function getStatusInfo(status) {
            let statusBadge = `<span class="status-pending" style="background:#FFF3E0; color:#E65100; padding:4px 8px; border-radius:4px;">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>`;
            if (status === 'confirmed') statusBadge = `<span class="status-paid" style="background:#E8F5E9; color:#2E7D32; padding:4px 8px; border-radius:4px;">‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</span>`;
            if (status === 'shipped') statusBadge = `<span class="status-shipped" style="background:#E3F2FD; color:#1565C0; padding:4px 8px; border-radius:4px;">‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>`;
            if (status === 'completed') statusBadge = `<span class="status-completed" style="background:#E8F5E9; color:#2E7D32; padding:4px 8px; border-radius:4px;">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>`;
            if (status === 'cancelled') statusBadge = `<span class="status-cancelled" style="background:#ffebee; color:#c62828; border:1px solid #ffcdd2; padding:4px 8px; border-radius:4px;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß</span>`;
            return statusBadge;
        }



        function toggleMenu() {
            const hamburger = document.getElementById('hamburger');
            const navMenu = document.getElementById('navMenu');
            hamburger.classList.toggle('active');
            navMenu.classList.toggle('active');
        }

        // Edit Profile Logic
        function openEditModal() {
            const userFullName = document.getElementById('fullName').innerText;
            const userPhone = document.getElementById('phone').innerText;
            // Address not currently shown in main view, let's assume we can fetch it or it's not critical to pre-fill if not valid
            // But better to fetch fresh user data or store it.
            // For now, let's pre-fill with what we have.
            document.getElementById('editFullName').value = userFullName !== '-' ? userFullName : '';
            document.getElementById('editPhone').value = userPhone !== '-' ? userPhone : '';
            // Address logic: we might need to fetch user again or store object.
            // Let's use the object stored in window if possible.
            if (window.currentUser) {
                document.getElementById('editAddress').value = window.currentUser.address || '';
            }

            document.getElementById('editProfileModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editProfileModal').classList.remove('active');
        }

        async function handleProfileUpdate(e) {
            e.preventDefault();

            const formData = new FormData();
            formData.append('full_name', document.getElementById('editFullName').value);
            formData.append('phone', document.getElementById('editPhone').value);
            formData.append('address', document.getElementById('editAddress').value);

            const password = document.getElementById('editPassword').value;
            if (password) {
                formData.append('password', password);
            }

            const avatarFile = document.getElementById('editAvatar').files[0];
            if (avatarFile) {
                formData.append('profile_picture', avatarFile);
            }

            try {
                const result = await api.updateProfile(formData);
                console.log('Update result:', result);

                await Swal.fire({
                    icon: 'success',
                    title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                    text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß',
                    timer: 1500,
                    showConfirmButton: false
                });

                closeEditModal();
                // Reload page to refresh data
                window.location.reload();
            } catch (error) {
                console.error('Update failed:', error);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: error.message
                });
            }
        }
    </script>
</body>

</html>