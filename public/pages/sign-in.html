<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="login-page-body">

    <header class="navbar">
        <div class="container">
            <a href="../" class="logo">üåæ EasyRice</a>
            <button class="hamburger" id="hamburger" onclick="toggleMenu()">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <nav id="navMenu">
            <ul>
                <li><a href="../">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a></li>
                <li><a href="product.html">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</a></li>
                <li><a href="about.html">‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£</a></li>
                <li><a href="contact.html">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</a></li>
            </ul>
        </nav>
            <a href="sign-in.html" class="btn-signin active">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a>
        </div>
    </header>

    <main class="login-main">
        <div class="login-card">
            <div class="login-header">
                <h2>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</h2>
                <p>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠</p>
            </div>

            <form id="loginForm" autocomplete="on" novalidate>
                <div id="login-message" style="display:none; margin-bottom:15px;"></div>
                <div class="form-group">
                    <label for="username">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                    <input type="text" id="username" class="form-control" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="password">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input type="password" id="password" class="form-control" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required autocomplete="current-password">
                </div>
                <div class="form-options">
                    <div class="remember-me">
                        <input type="checkbox" id="remember">
                        <label for="remember">‡∏à‡∏≥‡∏â‡∏±‡∏ô‡πÑ‡∏ß‡πâ</label>
                    </div>
                    <a href="forgot-password.html" class="forgot-password">‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô?</a>
                </div>
                <button type="submit" class="btn-primary full-width">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </form>
            
            <div class="sign-in-link" style="text-align:center; margin-top:15px;">
    <span>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ?</span>
    <a href="sign-up.html" style="color:#2e7d32; font-weight:500;">
        ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
    </a>
</div>

            <div class="divider"><span>‡∏´‡∏£‡∏∑‡∏≠</span></div>

            <div class="social-login">
                <button class="social-btn"><i class="fab fa-google"></i> Google</button>
                <button class="social-btn"><i class="fab fa-line"></i> LINE</button>
            </div>
        </div>
    </main>


    <script src="../js/api-client.js"></script>
    <script>
const loginForm = document.getElementById('loginForm');
const loginMsg = document.getElementById('login-message');

loginForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    loginMsg.style.display = 'none';
    loginMsg.innerHTML = '';

    const email = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    if (!email || !password) {
        showMsg('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', false);
        return;
    }

    try {
        // ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≤‡∏ô API
        const response = await api.login(email, password);
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å token
        api.setToken(response.token);

        // Decode JWT to get role
        let userRole = 'user';
        try {
            const parts = response.token.split('.');
            if (parts.length === 3) {
                let payload = parts[1];
                // Add padding if needed
                const padding = 4 - (payload.length % 4);
                if (padding !== 4) {
                    payload += '='.repeat(padding);
                }
                const decoded = JSON.parse(atob(payload));
                userRole = decoded.role || 'user';
            }
        } catch (e) {
            console.log('Could not decode role from token');
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        if (response.user) {
            localStorage.setItem('user_id', response.user.user_id || response.user.id);
            localStorage.setItem('username', response.user.username);
            localStorage.setItem('email', response.user.email);
            localStorage.setItem('full_name', response.user.full_name || response.user.username);
            localStorage.setItem('phone', response.user.phone || '');
            localStorage.setItem('role', userRole);
            localStorage.setItem('is_logged_in', 'true');
        }

        showMsg('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡∏ó‡∏≤‡∏á...', true);
        setTimeout(() => { 
            window.location.href = '../'; 
        }, 1200);
    } catch (error) {
        showMsg(error.message || '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', false);
    }
});

function showMsg(msg, success) {
    loginMsg.style.display = 'block';
    loginMsg.innerHTML = msg;
    loginMsg.style.background = success ? '#e8f5e9' : '#ffebee';
    loginMsg.style.color = success ? '#2e7d32' : '#c62828';
    loginMsg.style.border = success ? '1px solid #81c784' : '1px solid #e57373';
    loginMsg.style.padding = '10px 15px';
    loginMsg.style.borderRadius = '6px';
    loginMsg.style.textAlign = 'center';
}

// ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏ô‡∏π
function toggleMenu() {
    const hamburger = document.getElementById('hamburger');
    const navMenu = document.getElementById('navMenu');
    hamburger.classList.toggle('active');
    navMenu.classList.toggle('active');
}

// ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå
document.querySelectorAll('#navMenu a').forEach(link => {
    link.addEventListener('click', () => {
        document.getElementById('hamburger').classList.remove('active');
        document.getElementById('navMenu').classList.remove('active');
    });
});
</script>
<script src="../js/easyrice.js"></script>
</body>
</html>