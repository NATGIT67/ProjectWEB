<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/style.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-pending {
            background-color: #fff3e0;
            color: #ef6c00;
        }

        .status-success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .status-error {
            background-color: #ffebee;
            color: #c62828;
        }

        .btn-view {
            background: #2196F3;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .btn-view:hover {
            background: #1976D2;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>

<body>

    <header class="navbar">
        <div class="container">
            <a href="../" class="logo">üåæ EasyRice</a>
            <button class="hamburger" id="hamburger" onclick="toggleMenu()">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <nav id="navMenu">
                <ul>
                    <li><a href="../">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a></li>
                    <li><a href="product.html">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</a></li>
                    <li><a href="about.html">‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£</a></li>
                    <li><a href="contact.html">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</a></li>
                    <li><a href="history.html" class="active">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</a></li>
                </ul>
            </nav>
            <div class="user-profile">
                <a href="sign-in.html" class="btn-signin"
                    style="margin-left:10px; background: #ff5252 !important; color: white !important;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
            </div>
        </div>
    </header>

    <main class="container" style="margin-top: 50px; margin-bottom: 50px;">
        <div class="login-card" style="max-width: 1000px; width: 100%;">
            <div class="login-header"
                style="text-align: left; border-bottom: 2px solid var(--primary-color); padding-bottom: 15px;">
                <h2><i class="fas fa-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2>
                <p>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏Å‡∏î‡∏≥‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
            </div>

            <div class="order-history-table" style="margin-top: 25px; overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; text-align: left;">
                    <thead>
                        <tr style="background: var(--light-color); color: var(--dark-color);">
                            <th style="padding: 15px;">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</th>
                            <th style="padding: 15px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á</th>
                            <th style="padding: 15px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th>
                            <th style="padding: 15px;">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
                            <th style="padding: 15px;">‡∏°‡∏±‡∏î‡∏à‡∏≥ (50%)</th>
                            <th style="padding: 15px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th style="padding: 15px;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 15px;">#ER-2025001</td>
                            <td style="padding: 15px;">20 ‡∏ò.‡∏Ñ. 2025</td>
                            <td style="padding: 15px;">
                                <strong>‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏≠‡∏°‡∏°‡∏∞‡∏•‡∏¥ 105</strong><br>
                                <small>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô 50 ‡∏ñ‡∏≤‡∏î (‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á)</small>
                            </td>
                            <td style="padding: 15px;">‡∏ø650</td>
                            <td style="padding: 15px;">‡∏ø325</td>
                            <td style="padding: 15px;">
                                <span class="status-badge status-pending">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ</span>
                            </td>
                            <td style="padding: 15px;">
                                <button class="btn-view"><i class="fas fa-search"></i> ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
                            </td>
                        </tr>
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 15px;">#ER-2025002</td>
                            <td style="padding: 15px;">15 ‡∏ò.‡∏Ñ. 2025</td>
                            <td style="padding: 15px;">
                                <strong>‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏Å‡∏î‡∏≥‡∏Ç‡πâ‡∏≤‡∏ß (‡∏£‡∏ß‡∏°‡∏Å‡∏•‡πâ‡∏≤)</strong><br>
                                <small>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà 5 ‡πÑ‡∏£‡πà (‡∏à‡∏±‡∏î‡∏™‡πà‡∏á)</small>
                            </td>
                            <td style="padding: 15px;">‡∏ø9,000</td>
                            <td style="padding: 15px;">‡∏ø4,500</td>
                            <td style="padding: 15px;">
                                <span class="status-badge status-success">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
                            </td>
                            <td style="padding: 15px;">
                                <button class="btn-view"><i class="fas fa-search"></i> ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <script src="../js/api-client.js"></script>
        <script src="../js/easyrice.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                loadOrderHistory();
            });

            async function loadOrderHistory() {
                const tbody = document.getElementById('historyBody');
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>';

                // Check auth
                if (!api.getToken()) {
                    Swal.fire({
                        icon: 'error',
                        title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö',
                        text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠',
                        confirmButtonText: '‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'
                    }).then(() => {
                        window.location.href = 'sign-in.html';
                    });
                    return;
                }

                try {
                    const orders = await api.getOrders();

                    if (!orders || orders.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</td></tr>';
                        return;
                    }

                    tbody.innerHTML = '';
                    orders.forEach(order => {
                        console.log('Order Data:', order); // Debugging
                        const statusClass = getStatusClass(order.status);
                        const statusText = getStatusText(order.status);
                        // Format date
                        const dateObj = new Date(order.created_at || order.order_date);
                        const dateStr = dateObj.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });

                        // Display product info from new API fields
                        let productDisplay = '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û EasyRice';
                        if (order.first_product_name) {
                            productDisplay = order.first_product_name;
                            if (order.item_count > 1) {
                                productDisplay += ` ‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${order.item_count - 1} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                            }
                        }

                        // Robust ID and Price access
                        const orderId = order.order_id || order.id || '#Unknown';
                        const total = parseFloat(order.total_price || order.total || 0);
                        const paid = parseFloat(order.paid_amount || 0);

                        tbody.innerHTML += `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 15px;">#${orderId}</td>
                                <td style="padding: 15px;">${dateStr}</td>
                                <td style="padding: 15px;">
                                    <strong>${productDisplay}</strong>
                                </td>
                                <td style="padding: 15px;">‡∏ø${total.toLocaleString()}</td>
                                <td style="padding: 15px;">${depositDisplay}</td>
                                <td style="padding: 15px;">
                                    <span class="status-badge ${statusClass}">${statusText}</span>
                                </td>
                                <td style="padding: 15px;">
                                    <button class="btn-view" onclick="viewOrderDetails(${orderId})">
                                        <i class="fas fa-search"></i> ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                } catch (error) {
                    console.error('Failed to load history:', error);
                    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:red;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}</td></tr>`;
                    if (error.message.includes('401') || error.message.includes('403')) {
                        window.location.href = 'sign-in.html';
                    }
                }
            }

            function getStatusClass(status) {
                switch (status) {
                    case 'pending': return 'pending';
                    case 'paid': return 'success';
                    case 'completed': return 'success';
                    case 'cancelled': return 'error';
                    default: return 'pending';
                }
            }

            function getStatusText(status) {
                switch (status) {
                    case 'pending': return '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ';
                    case 'paid': return '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
                    case 'completed': return '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
                    case 'cancelled': return '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
                    default: return '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ';
                }
            }

            // Dynamic Username
            const user = JSON.parse(localStorage.getItem('easyrice_user'));
            if (user && user.full_name) {
                document.querySelector('.user-profile span').innerText = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ‡∏Ñ‡∏∏‡∏ì${user.full_name}`;
            } else if (user && user.username) {
                document.querySelector('.user-profile span').innerText = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ‡∏Ñ‡∏∏‡∏ì${user.username}`;
            }

            async function viewOrderDetails(orderId) {
                try {
                    const order = await api.getOrder(orderId);
                    if (order) {
                        const dateObj = new Date(order.created_at || order.order_date);
                        const dateStr = dateObj.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });

                        let itemsHtml = '';
                        if (order.items && order.items.length > 0) {
                            itemsHtml = order.items.map(i => `<li style="margin-bottom: 5px;">${i.product_name} x ${i.quantity} <span style="float:right;">‡∏ø${(i.price * i.quantity).toLocaleString()}</span></li>`).join('');
                        } else {
                            itemsHtml = '<li>‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</li>';
                        }

                        let slipHtml = '';
                        if (order.payment_slip) {
                            slipHtml = `
                                <div style="margin-top: 15px; text-align: center;">
                                    <p style="font-weight: bold; margin-bottom: 5px;">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:</p>
                                    <img src="${order.payment_slip}" style="max-width: 100%; max-height: 300px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                                </div>
                            `;
                        } else {
                            slipHtml = `<p style="text-align: center; color: #888; margin-top: 15px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</p>`;
                        }

                        // Create Modal HTML dynamically
                        const modalHtml = `
                            <div id="detailModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                                <div style="background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;">
                                    <h3 style="margin-top: 0; color: var(--primary-color); border-bottom: 2px solid #eee; padding-bottom: 10px;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ #${order.order_id || order.id}</h3>
                                    <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠:</strong> ${dateStr}</p>
                                    <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> <span class="status-badge ${getStatusClass(order.status)}">${getStatusText(order.status)}</span></p>
                                    <p><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á:</strong> ${order.shipping_address || '-'}</p>
                                    
                                    <div style="background: #f9f9f9; padding: 10px; border-radius: 8px; margin: 10px 0;">
                                        <ul style="list-style: none; padding: 0; margin: 0;">
                                            ${itemsHtml}
                                        </ul>
                                        <div style="border-top: 1px dashed #ccc; margin-top: 10px; padding-top: 10px; font-weight: bold; display: flex; justify-content: space-between;">
                                            <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                                            <span style="color: var(--primary-color); font-size: 1.2rem;">‡∏ø${parseFloat(order.total_price || order.total).toLocaleString()}</span>
                                        </div>
                                    </div>
                                    
                                    ${slipHtml}
                                    
                                    <button onclick="document.getElementById('detailModal').remove()" style="width: 100%; padding: 12px; border: none; background: #ddd; color: #333; font-weight: bold; border-radius: 8px; margin-top: 20px; cursor: pointer;">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
                                </div>
                            </div>
                        `;

                        // Append to body
                        const oldModal = document.getElementById('detailModal');
                        if (oldModal) oldModal.remove();
                        document.body.insertAdjacentHTML('beforeend', modalHtml);
                    }
                } catch (err) {
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏î‡πâ: ' + err.message);
                }
            }

            // Logout functionality
            document.querySelector('.btn-signin').addEventListener('click', function (e) {
                e.preventDefault();
                if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                    // In real app, clear session/token
                    window.location.href = 'sign-in.html';
                }
            });

            // Mobile menu toggle
            function toggleMenu() {
                const hamburger = document.getElementById('hamburger');
                const navMenu = document.getElementById('navMenu');
                hamburger.classList.toggle('active');
                navMenu.classList.toggle('active');
            }

            // Close menu when link clicked
            document.querySelectorAll('#navMenu a').forEach(link => {
                link.addEventListener('click', () => {
                    document.getElementById('hamburger').classList.remove('active');
                    document.getElementById('navMenu').classList.remove('active');
                });
            });
        </script>