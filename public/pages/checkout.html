<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/style.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map {
            width: 100% !important;
            height: 400px !important;
            border-radius: 10px;
            border: 2px solid #ddd;
            margin-bottom: 10px;
            display: block !important;
            background: #f0f0f0;
        }

        .leaflet-container {
            width: 100% !important;
            height: 400px !important;
        }
    </style>
</head>

<body class="login-page-body">

    <header class="navbar">
        <div class="container">
            <a href="#" class="logo">üåæ EasyRice</a>
            <button class="hamburger" id="hamburger" onclick="toggleMenu()">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <nav id="navMenu">
                <ul>
                    <li><a href="../">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a></li>
                    <li><a href="product.html" class="active">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</a></li>
                    <li><a href="about.html">‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£</a></li>
                    <li><a href="contact.html">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</a></li>
                </ul>
            </nav>
            <a href="sign-in.html" class="btn-signin">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a>
        </div>
    </header>

    <main class="container" style="margin-top: 50px; margin-bottom: 50px;">
        <div class="unified-contact-card" style="grid-template-columns: 1fr 1.5fr;">

            <div class="contact-sidebar">
                <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏Ç‡πâ‡∏≤‡∏ß</h2>
                <div class="product-preview" style="text-align: center;">
                    <img id="productImage" src="../images/jasmine105.png" alt="‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏≠‡∏°‡∏°‡∏∞‡∏•‡∏¥ 105" class="order-image"
                        style="max-width: 200px; height: auto; border-radius: 10px; margin-bottom: 15px;">
                    <div class="product-info-text">
                        <strong id="productName">‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏Ç‡πâ‡∏≤‡∏ß: ‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏≠‡∏°‡∏°‡∏∞‡∏•‡∏¥ 105</strong>
                        <p id="growthTime"><i class="fas fa-seedling"></i> ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï: 120 ‡∏ß‡∏±‡∏ô</p>
                        <p id="seedPrice"><i class="fas fa-tag"></i> ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≤: 13 ‡∏ö‡∏≤‡∏ó / ‡∏ñ‡∏≤‡∏î</p>
                        <p id="plantingPrice"><i class="fas fa-tractor"></i> ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏Å‡∏î‡∏≥: 1,800 ‡∏ö‡∏≤‡∏ó / ‡πÑ‡∏£‡πà (‡∏£‡∏ß‡∏°‡∏Å‡∏•‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß)
                        </p>
                    </div>
                </div>

                <div class="order-notice"
                    style="margin-top: 30px; padding: 15px; background: rgba(255,183,77,0.2); border-radius: 10px;">
                    <p style="color: var(--accent-color); font-weight: bold;">
                        <i class="fas fa-exclamation-triangle"></i> ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:
                    </p>
                    <p>‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡∏°‡∏±‡∏î‡∏à‡∏≥ 50% ‡∏Ç‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
                        ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ</p>
                </div>
            </div>

            <div class="contact-form-body">
                <h3>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>
                <form id="orderForm">
                    <div class="checkout-grid-form" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                            <input type="text" class="form-control" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" required>
                        </div>
                        <div class="form-group">
                            <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                            <input type="tel" class="form-control" placeholder="08X-XXX-XXXX" required
                                oninput="this.value = this.value.replace(/[^0-9]/g, '');" maxlength="10">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                        <input type="email" class="form-control" placeholder="example@gmail.com" required>
                    </div>

                    <div class="form-group">
                        <label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</label>
                        <textarea class="form-control" rows="2" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏î‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" required></textarea>
                    </div>

                    <div class="form-group">
                        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</label>
                        <div id="map"></div>
                        <p style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">üí°
                            ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡πâ‡∏≤‡∏¢‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</p>
                        <input type="hidden" id="lat" name="lat">
                        <input type="hidden" id="lng" name="lng">
                    </div>

                    <div class="checkout-grid-form" style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                            <select id="deliveryMethod" class="form-control">
                                <option value="self">‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏®‡∏π‡∏ô‡∏¢‡πå</option>
                                <option value="delivery">‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á‡∏ó‡∏µ‡πà</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group"
                        style="background: #f9f9f9; padding: 15px; border-radius: 10px; border: 1px dashed var(--primary-color);">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="plantingService" style="width: 20px; height: 20px;">
                            <span>‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏Å‡∏î‡∏≥ (1,800 ‡∏ö‡∏≤‡∏ó/‡πÑ‡∏£‡πà ‡∏£‡∏ß‡∏°‡∏Å‡∏•‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß)</span>
                        </label>
                    </div>

                    <div class="form-group" id="quantityArea">
                        <label id="quantityLabel">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏ñ‡∏≤‡∏î)</label>
                        <input type="number" id="quantity" class="form-control" value="1" min="1">
                    </div>

                    <div class="form-group"
                        style="background: #fff; padding: 15px; border-radius: 10px; border: 1px solid #ddd;">
                        <label style="font-weight: bold; margin-bottom: 10px; display: block;">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</label>
                        <div style="display: flex; gap: 20px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="radio" name="paymentType" value="full" checked onchange="calculatePrice()">
                                <span>‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="radio" name="paymentType" value="deposit" onchange="calculatePrice()">
                                <span>‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (‡∏°‡∏±‡∏î‡∏à‡∏≥ 50%)</span>
                            </label>
                        </div>
                    </div>

                    <div class="order-summary-box"
                        style="background: #3D4828; color: #fff; padding: 20px; border-radius: 10px; margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                            <strong id="totalPrice">‡∏ø0</strong>
                        </div>
                        <div id="depositRow"
                            style="display: none; justify-content: space-between; color: var(--accent-color); font-size: 1.2rem; font-weight: bold;">
                            <span>‡∏¢‡∏≠‡∏î‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢ (50%):</span>
                            <strong id="depositPrice">‡∏ø0</strong>
                        </div>
                        <div id="fullPriceRow"
                            style="display: flex; justify-content: space-between; color: var(--accent-color); font-size: 1.2rem; font-weight: bold;">
                            <span>‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞:</span>
                            <strong id="finalPayPrice">‡∏ø0</strong>
                        </div>
                    </div>

                    <button type="submit" class="btn-primary full-width"
                        style="margin-top: 20px; height: 55px; font-size: 1.2rem;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
                </form>
            </div>

        </div>
    </main>

    <div id="orderModal" class="modal-overlay" style="display: none;">
        <div class="login-card modal-content" style="max-width: 600px; padding: 30px;">
            <div class="login-header">
                <i class="fas fa-check-circle" style="font-size: 3rem; color: var(--primary-color);"></i>
                <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2>
                <button type="button" class="close-modal" onclick="closeOrderModal()"
                    style="background:none; border:none; font-size:1.5rem; position:absolute; top:20px; right:20px; cursor:pointer;">&times;</button>
                <p id="orderDateDisplay"></p>
            </div>

            <div class="summary-details" style="text-align: left; margin-bottom: 20px; color: var(--dark-color);">
                <div style="background: rgba(0,0,0,0.05); padding: 15px; border-radius: 10px;">
                    <p><strong>‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠:</strong> <span id="resName"></span></p>
                    <p><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</strong> <span id="resPhone"></span></p>
                    <p><strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:</strong> <span id="resDetails"></span></p>
                    <p><strong>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</strong> <span id="resProduct">‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏≠‡∏°‡∏°‡∏∞‡∏•‡∏¥ 105</span></p>
                    <p id="resQuantity"></p>
                    <p id="resQuantity"></p>
                    <hr style="margin: 10px 0; border: 0; border-top: 1px solid #ccc;">
                    <p style="font-size: 1.2rem;"><strong>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> <span id="resTotal"
                            style="color: var(--primary-color);"></span></p>
                    <p style="font-size: 1.3rem; color: #c62828;"><strong>‡∏¢‡∏≠‡∏î‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞ (50%):</strong> <span
                            id="resDeposit"></span></p>
                </div>
            </div>

            <div class="payment-section"
                style="border: 2px dashed var(--accent-color); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <h3><i class="fas fa-university"></i> ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
                <p>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢ (K-Bank)</p>
                <p style="font-size: 1.2rem; font-weight: bold; letter-spacing: 1px;">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: xxx-x-xxxx-xxx</p>
                <p>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ‡∏ö‡∏à‡∏Å. ‡∏≠‡∏µ‡∏ã‡∏µ‡πà‡πÑ‡∏£‡∏ã‡πå (EasyRice Co., Ltd.)</p>
                <div style="margin-top: 10px;">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=EasyRicePayment"
                        alt="QR Payment" style="width: 120px; border: 5px solid #fff;">
                    <p style="font-size: 0.8rem; color: #666;">‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡∏°‡∏±‡∏î‡∏à‡∏≥</p>
                </div>
            </div>

            <form id="paymentUploadForm">
                <div class="form-group" style="margin-top: 20px;">
                    <label
                        style="font-weight: 500; color: #333; display: block; margin-bottom: 10px;">‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏µ‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
                    <div class="file-upload-wrapper"
                        style="border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 10px; cursor: pointer; transition: 0.3s;"
                        onclick="document.getElementById('slipFile').click()">
                        <input type="file" id="slipFile" accept="image/*" style="display: none;"
                            onchange="previewSlip(this)">
                        <div id="uploadPlaceholder">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #888;"></i>
                            <p style="margin-top: 10px; color: #666;">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ</p>
                            <small style="color: #999;">(‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á)</small>
                        </div>
                        <img id="slipPreview"
                            style="max-width: 100%; max-height: 200px; display: none; margin-top: 10px; border-radius: 8px;">
                    </div>
                </div>
                <button type="button" onclick="finalizeOrder()"
                    class="btn-primary full-width">‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
            </form>
            <button type="button" onclick="closeOrderModal()" style="margin-top: 10px; background: #ddd; color: #333;"
                class="btn-primary full-width">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
        </div>
    </div>

    <div class="form-group">
        <label><i class="fas fa-edit"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
        <textarea id="additionalDetails" class="form-control" rows="3"
            placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏Ç‡πâ‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô..."></textarea>
    </div>

    <script src="../js/api-client.js"></script>
    <script>
        let selectedProduct = null;

        document.addEventListener('DOMContentLoaded', async function () {
            try {
                // Check if user is authenticated
                const user = await api.getCurrentUser();

                const urlParams = new URLSearchParams(window.location.search);
                const productId = urlParams.get('id');

                if (productId) {
                    // Fetch product from API
                    const product = await api.getProduct(productId);
                    selectedProduct = product.data || product;

                    const productName = selectedProduct.product_name || selectedProduct.name;
                    const productImg = selectedProduct.image_url || selectedProduct.img || '../images/jasmine105.png';
                    const productPrice = selectedProduct.price;

                    document.getElementById('productImage').src = productImg;
                    document.getElementById('productName').innerText = `‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏Ç‡πâ‡∏≤‡∏ß: ${productName}`;
                    document.getElementById('growthTime').innerHTML = `<i class="fas fa-seedling"></i> ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï: ${selectedProduct.age || 25} ‡∏ß‡∏±‡∏ô`;
                    document.getElementById('seedPrice').innerHTML = `<i class="fas fa-tag"></i> ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≤: ${productPrice} ‡∏ö‡∏≤‡∏ó / ‡∏ñ‡∏≤‡∏î`;
                } else {
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
                    window.location.href = 'product.html';
                }
            } catch (error) {
                console.error('Auth error:', error);
                // Clear token if it's invalid to prevent endless loop of "I have token" -> "Invalid" -> "Redirect"
                if (localStorage.getItem('token')) {
                    api.clearToken();
                }
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠');
                window.location.href = 'sign-in.html?redirect=checkout.html'; // Add redirectParam logic if implemented in sign-in
                return;
            }

            // Initialize map
            console.log('Initializing map...');
            var mapElement = document.getElementById('map');
            console.log('Map element:', mapElement);

            if (mapElement) {
                var map = L.map('map', {
                    dragging: true,
                    touchZoom: true,
                    scrollWheelZoom: true
                }).setView([13.7563, 100.5018], 10);

                console.log('Map created:', map);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                var marker = L.marker([13.7563, 100.5018], { draggable: true }).addTo(map);

                // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡∏≤‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
                marker.on('dragend', function () {
                    var coords = marker.getLatLng();
                    document.getElementById('lat').value = coords.lat.toFixed(6);
                    document.getElementById('lng').value = coords.lng.toFixed(6);
                });

                // ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÇ‡∏î‡∏¢‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                map.on('click', function (e) {
                    marker.setLatLng(e.latlng);
                    document.getElementById('lat').value = e.latlng.lat.toFixed(6);
                    document.getElementById('lng').value = e.latlng.lng.toFixed(6);
                });

                document.getElementById('lat').value = 13.7563;
                document.getElementById('lng').value = 100.5018;
            } else {
                console.error('Map element not found!');
            }
        });

        const quantityInput = document.getElementById('quantity');
        const plantingCheck = document.getElementById('plantingService');
        const totalPriceEl = document.getElementById('totalPrice');
        const depositPriceEl = document.getElementById('depositPrice');
        const quantityLabel = document.getElementById('quantityLabel');

        function calculatePrice() {
            let total = 0;
            const qty = parseInt(quantityInput.value) || 0;

            if (plantingCheck.checked) {
                quantityLabel.innerText = "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡πÑ‡∏£‡πà)";
                total = qty * 1800;
            } else {
                quantityLabel.innerText = "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏ñ‡∏≤‡∏î)";
                total = qty * (selectedProduct?.price || 35);
            }

            const deposit = total * 0.5;

            const paymentType = document.querySelector('input[name="paymentType"]:checked').value;
            const depositRow = document.getElementById('depositRow');
            const fullPriceRow = document.getElementById('fullPriceRow');
            const finalPayPrice = document.getElementById('finalPayPrice');

            totalPriceEl.innerText = `‡∏ø${total.toLocaleString()}`;
            depositPriceEl.innerText = `‡∏ø${deposit.toLocaleString()}`;

            if (paymentType === 'deposit') {
                depositRow.style.display = 'flex';
                fullPriceRow.style.display = 'none'; // Hide full price row if showing deposit? Or show "Pay Now: XXX"
                // Better:
                depositRow.style.display = 'flex';
                fullPriceRow.innerHTML = `<span>‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</span> <strong>‡∏ø${deposit.toLocaleString()}</strong>`;
            } else {
                depositRow.style.display = 'none';
                fullPriceRow.innerHTML = `<span>‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</span> <strong>‡∏ø${total.toLocaleString()}</strong>`;
            }
        }

        quantityInput.addEventListener('input', calculatePrice);
        plantingCheck.addEventListener('change', calculatePrice);

        // Initial Calculation
        calculatePrice();

        document.getElementById('orderForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const productName = selectedProduct?.product_name || selectedProduct?.name || '‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏≠‡∏°‡∏°‡∏∞‡∏•‡∏¥ 105';
            // Populate modal
            document.getElementById('resName').innerText = document.querySelector('input[placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì"]').value;
            document.getElementById('resPhone').innerText = document.querySelector('input[placeholder="08X-XXX-XXXX"]').value;
            document.getElementById('resDetails').innerText = document.getElementById('additionalDetails').value || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏∞‡∏ö‡∏∏";
            document.getElementById('resProduct').innerText = productName;
            document.getElementById('resQuantity').innerText = `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${quantityInput.value} ${plantingCheck.checked ? '‡πÑ‡∏£‡πà' : '‡∏ñ‡∏≤‡∏î'}`;
            document.getElementById('resTotal').innerText = totalPriceEl.innerText;
            document.getElementById('resDeposit').innerText = depositPriceEl.innerText;
            document.getElementById('orderDateDisplay').innerText = new Date().toLocaleDateString('th-TH');
            document.getElementById('orderModal').style.display = 'flex';
        });

        function closeOrderModal() {
            document.getElementById('orderModal').style.display = 'none';
        }

        function previewSlip(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('slipPreview').src = e.target.result;
                    document.getElementById('slipPreview').style.display = 'block';
                    document.getElementById('uploadPlaceholder').style.display = 'none';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function finalizeOrder() {
            try {
                const slipFile = document.getElementById('slipFile');
                // Optional: require slip
                // if (!slipFile.files.length) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ'); return; }

                // Get shipping address from form
                const address = document.querySelector('textarea[placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏î‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"]').value;
                if (!address) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á');
                    return;
                }

                let slipBase64 = null;
                if (slipFile.files.length > 0) {
                    const file = slipFile.files[0];
                    if (file.size > 5 * 1024 * 1024) { // 5MB limit check (client side)
                        alert('‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏•‡∏¥‡∏õ‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB)');
                        return;
                    }
                    slipBase64 = await toBase64(file);
                }

                // --- Handle "Buy Now" flow ---
                // If we are in "Buy Now" mode (URL params present), we need to ensure this item is in the cart
                // Because api.createOrder() creates order from the backend Cart table.
                const urlParams = new URLSearchParams(window.location.search);
                const productId = urlParams.get('id');
                const quantityRaw = document.getElementById('quantity').value; // Get current quantity from input

                if (productId) {
                    // 1. Clear existing cart (to avoid mixing with old items) - Optional but safer for "Buy Now"
                    // Note: We might want a specific API for "clear cart" or "set cart", but for now looping delete or assuming empty is tricky.
                    // Let's just Add to Cart. If user had items, they will be included. 
                    // ideally "Buy Now" should trigger a different backend endpoint, but let's reuse existing.
                    // Better approach for now: Just Add/Update this item to cart.

                    // Actually, to prevent "Cart is empty" error, we MUST ensure the item is added.
                    console.log('Adding "Buy Now" item to cart...', productId, quantityRaw);
                    try {
                        await api.addToCart(productId, parseInt(quantityRaw));
                    } catch (cartErr) {
                        console.warn('Add to cart warning:', cartErr);
                        // Continue, maybe it's already there or duplicate key update worked
                    }
                }

                const paymentType = document.querySelector('input[name="paymentType"]:checked').value;

                // Create order via API (which uses backend Cart)
                const orderResponse = await api.createOrder(address, slipBase64, paymentType);

                if (orderResponse && (orderResponse.id || orderResponse.order_id)) {
                    alert('‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå: ' + (orderResponse.id || orderResponse.order_id));
                    window.location.href = 'history.html';
                } else {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (orderResponse?.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Order error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        // Mobile menu toggle
        function toggleMenu() {
            const hamburger = document.getElementById('hamburger');
            const navMenu = document.getElementById('navMenu');
            hamburger.classList.toggle('active');
            navMenu.classList.toggle('active');
        }

        // Close menu when link clicked
        document.querySelectorAll('#navMenu a').forEach(link => {
            link.addEventListener('click', () => {
                document.getElementById('hamburger').classList.remove('active');
                document.getElementById('navMenu').classList.remove('active');
            });
        });
    </script>

    <script src="../js/easyrice.js"></script>
</body>

</html>